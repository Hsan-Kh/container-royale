<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Royale: Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #282c34; color: white; margin: 0; padding: 0; }
        .container { max-width: 700px; margin: 0 auto; padding: 20px; }
        .box { background: #3b404e; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 20px; }
        
        button { padding: 12px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; background: #61dafb; color: #282c34; border: none; border-radius: 8px; margin-top: 10px; transition: 0.2s; }
        button:hover { background: #21a1f1; }
        .secondary-btn { background: #555; color: white; }
        .secondary-btn:hover { background: #666; }

        input, select { padding: 12px; width: 90%; margin: 5px 0; border-radius: 5px; border: none; }
        
        .split-view { display: flex; gap: 20px; margin-top: 10px; }
        .split-box { flex: 1; background: #2c313c; padding: 15px; border-radius: 10px; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .correct-btn { background-color: #2ecc71 !important; color: white !important; }
        .wrong-btn { background-color: #e74c3c !important; opacity: 0.5; }
        #timer-bar { height: 10px; background: #e74c3c; width: 100%; transition: width 1s linear; }
        .room-code { font-size: 32px; letter-spacing: 5px; color: #f1c40f; font-weight: bold; margin: 10px 0; border: 2px dashed #f1c40f; padding: 10px; display: inline-block; }

        .rank-item { background: #222; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; }
        .rank-1 { background: #f1c40f; color: #000; font-weight: bold; border: 2px solid white; transform: scale(1.05); }
        .rank-2 { background: #bdc3c7; color: #000; }
        .rank-3 { background: #cd7f32; color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Container Royale</h1>

        <!-- 1. LOGIN -->
        <div id="login" class="box">
            <h2>Login</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login / Register</button>
            <p id="login-msg" style="color: #f1c40f;"></p>
        </div>

        <!-- 2. DASHBOARD -->
        <div id="dashboard" class="box" style="display:none;">
            <h2 id="welcome-msg">Welcome</h2>
            
            <div class="split-view">
                <div class="split-box">
                    <h3>Host a Match</h3>
                    <select id="category">
                        <option value="9">General Knowledge</option>
                        <option value="18">Computers</option>
                        <option value="21">Sports</option>
                        <option value="23">History</option>
                    </select>
                    <button onclick="createGame()">Create Room</button>
                </div>
                <div class="split-box">
                    <h3>Join a Match</h3>
                    <input type="text" id="room-code-input" placeholder="Enter Room Code" style="text-transform:uppercase;">
                    <button onclick="joinGame()" class="secondary-btn">Join Room</button>
                </div>
            </div>
            <br>
            <button onclick="showHistory()" style="background: #e67e22;">View History</button>
        </div>

        <!-- 3. WAITING ROOM -->
        <div id="waiting-room" class="box" style="display:none;">
            <h2>‚è≥ Lobby</h2>
            <div id="host-info" style="display:none;">
                <p>Code de la salle :</p>
                <div id="display-code" class="room-code">----</div>
            </div>
            <p id="wait-msg">Connecting...</p>
            <p style="color:red" id="error-msg"></p>
            <button onclick="location.reload()" class="secondary-btn">Quitter</button>
        </div>

        <!-- 4. HISTORY -->
        <div id="history-view" class="box" style="display:none;">
            <h3>Match History</h3>
            <ul id="history-list" style="text-align:left; padding-left:20px;"></ul>
            <button onclick="backToDash()">Back</button>
        </div>

        <!-- 5. GAME SCREEN -->
        <div id="game" class="box" style="display:none;">
            <div style="background: #555; border-radius: 5px; overflow: hidden; margin-bottom: 10px;">
                <div id="timer-bar"></div>
            </div>
            <p>Question <span id="q-num">1</span> / 10</p>
            <h2 id="q-text">Loading...</h2>
            <div id="options" class="btn-grid"></div>
            <hr style="margin-top:20px; border-color:#555;">
            <h3>Classement Live:</h3>
            <div id="scores"></div>
        </div>

        <!-- 6. GAME OVER -->
        <div id="game-over" class="box" style="display:none;">
            <h2>üèÜ R√©sultats Finaux</h2>
            <div id="final-results" style="text-align: left;"></div>
            <br>
            <button onclick="location.reload()">Retour Menu</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:3000');
        let myName = "";
        let currentButtons = [];

        function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u && p) socket.emit('login', { username: u, password: p });
        }

        socket.on('login_success', (data) => {
            myName = data.username;
            document.getElementById('login').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('welcome-msg').innerText = `Hello, ${myName}!`;
        });
        
        socket.on('login_error', (msg) => document.getElementById('login-msg').innerText = msg);

        function createGame() {
            const cat = document.getElementById('category').value;
            socket.emit('create_game', { username: myName, category: cat });
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('waiting-room').style.display = 'block';
            document.getElementById('host-info').style.display = 'block';
        }

        socket.on('game_created', (data) => {
            document.getElementById('display-code').innerText = data.roomCode;
        });

        function joinGame() {
            const code = document.getElementById('room-code-input').value.toUpperCase();
            if(!code) return alert("Code requis");
            socket.emit('join_game', { username: myName, roomCode: code });
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('waiting-room').style.display = 'block';
            document.getElementById('host-info').style.display = 'none';
        }

        socket.on('error_message', (msg) => document.getElementById('error-msg').innerText = msg);
        socket.on('waiting_message', (msg) => document.getElementById('wait-msg').innerText = msg);

        socket.on('game_status', (data) => {
            if (data.status === 'started') {
                document.getElementById('waiting-room').style.display = 'none';
                document.getElementById('game').style.display = 'block';
            }
        });

        socket.on('new_question', (data) => {
            document.getElementById('q-text').innerText = data.q;
            document.getElementById('q-num').innerText = data.number;
            const div = document.getElementById('options');
            div.innerHTML = ""; 
            currentButtons = [];
            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt;
                btn.onclick = () => submitAnswer(opt, btn);
                div.appendChild(btn);
                currentButtons.push({ text: opt, element: btn });
            });
        });

        function submitAnswer(answer, btnElement) {
            currentButtons.forEach(b => b.element.disabled = true);
            socket.emit('submit_answer', { username: myName, answer: answer });
        }

        socket.on('answer_result', (data) => {
            currentButtons.forEach(item => {
                if (item.text === data.correctAnswer) item.element.classList.add('correct-btn');
                else item.element.classList.add('wrong-btn');
            });
            if (data.correct) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        });

        socket.on('timer_update', (time) => {
            document.getElementById('timer-bar').style.width = `${(time / 15) * 100}%`;
        });

        socket.on('leaderboard_update', (players) => {
            players.sort((a,b) => b.score - a.score);
            document.getElementById('scores').innerHTML = players.map((p, i) => 
                `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding:5px;">
                    <span>#${i+1} ${p.name}</span>
                    <span>${p.score} pts</span>
                </div>`
            ).join('');
        });

        socket.on('game_over', (players) => {
            document.getElementById('game').style.display = 'none';
            document.getElementById('game-over').style.display = 'block';
            
            let html = players.map((p, i) => {
                let rankClass = i === 0 ? "rank-1" : (i === 1 ? "rank-2" : (i === 2 ? "rank-3" : "rank-item"));
                return `<div class="rank-item ${rankClass}">
                            <span>#${i+1} ${p.name}</span>
                            <span>${p.score} pts</span>
                        </div>`;
            }).join('');
            
            document.getElementById('final-results').innerHTML = html;
        });

        function showHistory() {
            socket.emit('get_history', myName);
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('history-view').style.display = 'block';
        }

        socket.on('history_data', (history) => {
            const list = document.getElementById('history-list');
            list.innerHTML = history.length ? history.map(h => 
                `<li><strong>${h.result}</strong> | ${h.opponent} | Score: ${h.score} | ${h.date}</li>`
            ).join('') : '<p>Pas encore de partie.</p>';
        });

        function backToDash() {
            document.getElementById('history-view').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }
    </script>
</body>
</html>